
## MALWARE : MALICIOUS SOFTWARE

Quelque chose qui s’exécute
- Parfois ce n’est pas censé le faire (prévisualisation des fichiers offices
dans l’explorateur Windows, exécute les macros)
Mais pas avec le comportement attendu
- Pourquoi un économiseur d’écran dump le process lsass.exe ?


## CARACTERISTIQUES

Cache ses fonctions internes
- Chiffrement ou Packing (compression et encapsulation)
- Encodage des chaînes
- Chargement dynamique des DLL
- Encapsulation (poupées russes, multiples étages)

Protections pour retarder l’analyse
- Offuscation
- Anti-debug
- Anti-VM (pour tromper les sandbox)
- Contournement des AV/EDR


## SANDBOX

Simule un environnement d’exécution pour faire « détoner »
le malware, observer son comportement système et réseau,
récolter des marqueurs / IOCs
Souvent couplé avec plusieurs antivirus
Mais:
- Facile pour un malware de comprendre qu’il est dans une VM et donc de ne pas
dévoiler ces fonctions malveillantes, ou alors on attend une action de
l’utilisateur... (mouvement de souris) qui n’arrive jamais dans une sandbox
- Et pour interpréter les résultats détaillés ou un verdict suspect, il faut connaitre
les bases de l’analyse de malware: vous n’avez pas le choix


## QUELQUE CHOSE QUI S’EXECUTE

Du code dans un document
- PDF
- Fichiers office (.doc, .xls, .ppt, .xlsx, ...)
- RTF
- ...
Un script
- Powershell (.ps1)
- Javascript
- VBA (dans les documents Office)
- Shell
- AutoIt
- .bat
Binaires
- Win32/Win64
- ELF


## OFFUSCATION

Rendre difficile la compréhension du code
- Possible quel que soit le langage

[The Goot cause: Detecting Gootloader and its follow-on activity](https://redcanary.com/blog/gootloader/)


## DETECTER LE CHIFFREMENT OU LE PACKING

Calculer l’entropie
- Proche de 8.0 : chiffrement
- Entre 6.5 et 7.5 : compression


## MALDOC : MALICIOUS DOCUMENT

Il est possible d’exécuter du code dans un PDF ou un
document Office à l’ouverture du document ou suite à
une action utilisateur

- PDF : Javascript,
- XLS : Macro Excel4
- Doc, Xls, ppt : VBA


## PDF : PORTABLE DOCUMENT FORMAT

Basé sur postscript (format texte)
À base d’objets

Pour l’analyser: pdfid et pdf-parser de Didier Stevens

https://blog.didierstevens.com/programs/pdf-tools/
https://www.pdfa.org/resource/pdf-specification-index/


## DOCUMENTS MICROSOFT OFFICE

2 formats (avant et après 2007)
- OLE2 : système de fichier, avec des « flux »
- OpenXML : fichiers XML dans une archive Zip

https://www.decalage.info/python/oletools
https://www.sstic.org/user/plagadec/


## OLETOOLS, POUR OLE2 SURTOUT

À utiliser dans l’ordre : oleid, oleobj, olevba


## OLEDUMP (FORMAT OLE2)

Pour aller plus loin, analyser la structure et les flux OLE2
Extraire un flux, le décoder

Plug-ins pour les vba, ppt, xls et msg
- Pour analyser un email office .msg sans l’ouvrir

https://blog.didierstevens.com/programs/oledump-py/


## EXECUTABLE (WINDOWS)

Fichier sur disque conçu pour devenir un processus
Conçu pour de multiples architectures (x32, x64, arm, ...)

Tâches à réaliser par le loader:
- Charger le code en mémoire
- Initialiser la pile et le tas
- Translater les adresses dans le code
- Charger les bibliothèques partagées (.dll ou .so)
- Linker les adresses des fonctions externe à l’espace mémoire du processus

Windows: format Portable Executable (PE):
https://learn.microsoft.com/en-us/windows/win32/debug/pe-format


## WINDOWS PE: EN HEXA ?

Commence par la valeur « MZ »
Plus loin, il y a la partie « PE »
Et les noms des sections, ici « .text », « .rdata »


## WIN PE : ENTÊTE DOS

MZ est un header DOS historique


## WIN PE : ENTÊTE PE / NT

PE ou NT_header est le header principal
En forensic on aime les timestamps!
Mais il peut être modifié sans traces par l’attaquant


## WIN PE : ENTÊTE RICH

Fournit les versions des fichiers objets composant l’exe (encodé avec une clé xor). Uniquement avec Visual Studio.
Cela peut être utilisé comme signature de la chaîne de compilation de l’attaquant... ou pour tromper l’analyste


## WIN PE : SECTIONS

Nom des sections (optionnel). « .text » pour le code,
« .rdata » pour données / constantes initialisées, « .rsrc » pour les resources (éléments GUI)
RAW addr et size = sur le disque
Virtual addr et size = en mémoire
Ici : le mapping fichier et mémoire est identique, aux alignements prêts : rien de bizarre
« Overlay » = données après la fin officielle du fichier. Plutôt inhabituel


## WIN PE : PROPRIÉTÉS DES SECTIONS

Remarques: le nom d’une section est un usage, aucune obligation. Le nombre classique de sections entre 4 et 7.
Seule la section « .text » devrait être « x » : exécutable (droit de la portion mémoire)
Seule la section « .data » devrait être « w » : writable (variables locales)
Les autres sections sont normalement « r » : read only


## WIN PE : ENTRY POINT

Le point d’entrée se situe normalement dans la section code « .text ». Il s’agit de l’adresse où sera lancé le code du processus.
(0x400 + 0xc00 = 0x1000, 0x591e0 + 0xc00 = 0x59de0)


## WIN PE : IMPORTS

Imports: listes des DLL et fonctions utilisées Ici FindFirstFileW, FindNextFileW et GtFileAttributesW
Fonctions légitimes pour 7zip = archiver une arborescence de fichiers


## WIN PE : MASQUER LES IMPORTS

Connaître l’API système permet de connaître les fonctions offertes par les librairies partagées (DLL ou .so)
L’import de telles DLL et l’usage de ces fonctions décrivent le fonctionnement interne d’un exécutable
C’est pour cela que les malware cachent les imports, et ré-implémentent un « loader » pour échapper à la surveillance sécurité.


## WIN PE : CHARGEMENT ET RÉSOLUTION DYNAMIQUE

Plutôt que de laisser faire le loader Windows avec imports officiels (et visibles), les malware peuvent le faire eux-mêmes
Les fonctions typiquement utilisées sont:
- VirtualAlloc/VirtualProtect : allouer et changer les droits d’une portion mémoire
- LoadLibraryA pour y charger une DLL
- GetProcAddress pour résoudre / connecter les adresses des fonctions chargées avec le code de l’exécutable
Chargement et résolution dynamiques != malveillant. Contre exemple : plug-ins


## WIN PE : PACKER POUR MASQUER

Packer : Outil qui compresse ou chiffre un exécutable. L’opération
inverse se réalise lors de l’exécution du binaire en version « packé ».
1- exe1 : entry point 1
2- exe2 : [ packer_stub – exe1_packé]
Lorsque l’on exécute exe2 [entry point2], le code « stub » alloue la mémoire, décompresse exe1 dans cet espace mémoire, reconstitue les imports, puis on exécute via l’entry point original (OEP=original entry point1)

https://kindredsec.wordpress.com/2020/01/07/the-basics-of-packed-malware-manually-unpacking-upx-executables/


## WIN PE : LANGAGE D’ORIGINE ?

Quelques packers: WinRar, UPX, ASPack, ...
Un exécutable avec beaucoup d’imports est souvent basé sur un interpréteur : AutoIt, PyInstaller, Delphi, .Net, Java, ... peut on retrouver le code source ? On ne voit plus les fonctions réellement utilisées.
Pour les langages compilés, quel est-il ? C, C++, Rust, Go ? Il faudra retrouver les fonctions, les structures de données.
Parfois des indices se trouvent dans la section « .rsrc »


## WINDOWS PE : RÉSUMÉ DES ANOMALIES POSSIBLES

- Le nombre, les noms et les propriétés (rwx) des sections sont-ils inhabituels ?
- La section « .rsrc » est exécutable ?
- Il y a plusieurs sections « writable » ?
- « w » et « x », c’est louche !
- Voir : https://www.hexacorn.com/blog/2016/12/15/pe-section-names-re-visited/
- Les tailles de chaque section sur disque et en mémoire sont sont-elles cohérentes ? Taille zéro en mémoire ?
- Le nombre de DLLs il est anormalement faibles ? <5 par exemple
- Le nombre de fonctions importées est-il anormalement faibles ? <5
- Les fonctions utilisées sont elles compatibles avec le rôle de l’application ?
- Anomalies != malveillant


## WINDOWS PE : OUTILLAGE

DiE (Detect It Easy)
- pour deviner les packers, analyser le PE, avec des signatures
- Versions console et GUI
- Hashes des différentes sections
- Calcul d’entropie
- Analyse de la structure PE

https://github.com/horsicq/Detect-It-Easy


## WINDOWS PE : PE-BEAR

Par @hasherezade
- pour explorer la structure et les propriétés d’un exécutable PE

https://github.com/hasherezade/pe-bear
https://github.com/hasherezade/pe-bear/releases


## ANALYSE STATIQUE : CAPA(BILITIES)

“extracts features from files, such as strings, disassembly, and control flow”. “Second, a logic engine finds combinations of features that are expressed in a common rule format. When the logic engine finds a match, capa reports on the capability described by the rule.”
https://github.com/mandiant/capa

Installer le binaire Windows: capa-v4.0.1-windows.zip
https://github.com/mandiant/capa/releases


## ANALYSE DYNAMIQUE : IDA FREEWARE

IDA Pro est l’outil de référence, surtout de par les possibilités d’extension (plug-ins) et d’automatisation (scripts).
Il existe une version gratuite, que nous allons utiliser en TD.

https://hex-rays.com/ida-free/












